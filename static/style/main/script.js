const tt=document.getElementById('theme-toggle'),b=document.body,ti=tt?tt.querySelector('i'):null,rl=document.getElementById('resultsList'),vg=document.getElementById('votingGrid');const savedTheme=localStorage.getItem('theme');function applyTheme(t){if(!b)return;b.classList.toggle('dark-mode',t==='dark');if(ti){ti.classList.toggle('fa-sun',t==='dark');ti.classList.toggle('fa-moon',t!=='dark')}document.querySelectorAll('.lang-logo').forEach(i=>{const p=i.closest('.result-item');if(!(p&&p.dataset.lang==='assembler'))i.style.filter=b.classList.contains('dark-mode')?'var(--logo-filter-dark)':'var(--logo-filter-light)'})}if(b)applyTheme(savedTheme||'light');else document.addEventListener('DOMContentLoaded',()=>applyTheme(savedTheme||'light'),{once:!0});if(tt)tt.addEventListener('click',()=>{const nT=b.classList.contains('dark-mode')?'light':'dark';applyTheme(nT);localStorage.setItem('theme',nT)});function getLogo(k){const l={'python':"https://upload.wikimedia.org/wikipedia/commons/c/c3/Python-logo-notext.svg",'javascript':"https://upload.wikimedia.org/wikipedia/commons/6/6a/JavaScript-logo.png",'java':"https://www.vectorlogo.zone/logos/java/java-icon.svg",'csharp':"https://upload.wikimedia.org/wikipedia/commons/b/bd/Logo_C_sharp.svg",'rust':"https://upload.wikimedia.org/wikipedia/commons/d/d5/Rust_programming_language_black_logo.svg",'go':"https://upload.wikimedia.org/wikipedia/commons/0/05/Go_Logo_Blue.svg",'cplusplus':"https://upload.wikimedia.org/wikipedia/commons/1/18/ISO_C%2B%2B_Logo.svg",'swift':"https://upload.wikimedia.org/wikipedia/commons/9/9d/Swift_logo.svg",'kotlin':"https://upload.wikimedia.org/wikipedia/commons/7/74/Kotlin_Icon.svg",'php':"https://upload.wikimedia.org/wikipedia/commons/2/27/PHP-logo.svg",'ruby':"https://upload.wikimedia.org/wikipedia/commons/7/73/Ruby_logo.svg",'assembler':"https://www.svgrepo.com/show/475651/cpu-chip.svg"};return l[k]||null}function capLang(k){if(!k)return"";if(k==='csharp')return'C#';if(k==='cplusplus')return'C++';return k.charAt(0).toUpperCase()+k.slice(1)}document.addEventListener('DOMContentLoaded',async()=>{if(b){b.style.opacity=0;requestAnimationFrame(()=>{b.style.transition='opacity .5s ease-in';b.style.opacity=1});applyTheme(localStorage.getItem('theme')||'light')}const allL=['python','javascript','java','csharp','rust','go','cplusplus','swift','kotlin','php','ruby','assembler'];let vD={},mV=0;for(const lK of allL){try{const r=await fetch('http://localhost:8080/api/get-count',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:lK})});if(!r.ok)continue;const res=await r.json(),cnt=parseInt(res.count_vote,10);if(!isNaN(cnt)){vD[lK]=cnt;if(cnt>mV)mV=cnt;if(vg){const vcEl=document.getElementById(`votes-${lK}`);if(vcEl)vcEl.textContent=cnt}}}catch(e){}}if(rl){const sR=Object.keys(vD).map(key=>({lang:key,count:vD[key]})).sort((a,b)=>b.count-a.count);if(sR.length===0&&Object.keys(vD).length===0){rl.innerHTML="<p>Пока никто не проголосовал или не удалось загрузить данные. Будь первым!</p>";rl.classList.add('empty')}else{rl.innerHTML='';const frag=document.createDocumentFragment();sR.forEach(iD=>{const iEl=document.createElement('div');iEl.classList.add('result-item');iEl.dataset.lang=iD.lang;const lSrc=getLogo(iD.lang);if(lSrc){const ig=document.createElement('img');ig.src=lSrc;ig.alt=`${iD.lang} Logo`;ig.classList.add('lang-logo');ig.loading='lazy';iEl.appendChild(ig)}const infD=document.createElement('div');infD.classList.add('result-info');const tEl=document.createElement('h2');tEl.classList.add('lang-title');tEl.textContent=capLang(iD.lang);infD.appendChild(tEl);const bC=document.createElement('div');bC.classList.add('vote-bar-container');const vBar=document.createElement('div');vBar.classList.add('vote-bar');const bW=mV>0?(iD.count/mV)*100:0;vBar.style.width='0%';vBar.dataset.targetWidth=bW;bC.appendChild(vBar);infD.appendChild(bC);const vcS=document.createElement('span');vcS.classList.add('result-votes');vcS.textContent=iD.count;iEl.appendChild(infD);iEl.appendChild(vcS);frag.appendChild(iEl)});rl.appendChild(frag);applyTheme(b.classList.contains('dark-mode')?'dark':'light');setTimeout(()=>{document.querySelectorAll('.vote-bar').forEach(bA=>{bA.style.width=`${bA.dataset.targetWidth}%`})},100)}}if(b){const obs=new MutationObserver(m=>{m.forEach(mu=>{if(mu.attributeName==='class')applyTheme(b.classList.contains('dark-mode')?'dark':'light')})});obs.observe(b,{attributes:!0})}document.querySelectorAll('.vote-button').forEach(btn=>{btn.addEventListener('click',async(evt)=>{const lK=evt.target.dataset.target;if(!lK)return;const origTxt=evt.target.textContent;evt.target.disabled=!0;evt.target.textContent='Голосуем...';try{const r=await fetch('http://localhost:8080/api/voted',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:lK})});if(r.ok){const res=await r.json(),nCnt=parseInt(res.votes!==undefined?res.votes:res.count_vote,10),vLK=res.language?res.language.toLowerCase():lK.toLowerCase();if(!isNaN(nCnt)&&res.language&&vD.hasOwnProperty(vLK)){vD[vLK]=nCnt;if(nCnt>mV)mV=nCnt;const vcEl=document.getElementById(`votes-${vLK}`);if(vcEl)vcEl.textContent=nCnt;evt.target.textContent='Спасибо!';setTimeout(()=>{evt.target.textContent=origTxt;evt.target.disabled=!1},2000);if(typeof confetti==='function'){const rct=evt.target.getBoundingClientRect(),xPos=(rct.left+rct.right)/2/window.innerWidth,yPos=(rct.top+rct.bottom)/2/window.innerHeight;confetti({particleCount:100,spread:70,origin:{x:xPos,y:yPos}})}}else{evt.target.textContent='Ошибка данных!';setTimeout(()=>{evt.target.textContent=origTxt;evt.target.disabled=!1},3000)}}else{let uMsg=`Ошибка ${r.status}`;if(r.status===401)uMsg='Ошибка: Токен не найден.';else if(r.status===403)uMsg='Вы уже голосовали!';else uMsg=`Ошибка сервера (${r.status}).`;evt.target.textContent=uMsg;setTimeout(()=>{evt.target.textContent=origTxt;evt.target.disabled=!1},2000)}}catch(er){evt.target.textContent='Ошибка сети!';setTimeout(()=>{evt.target.textContent=origTxt;evt.target.disabled=!1},2000)}})})});