const b=document.body,tt=document.getElementById('theme-toggle'),ti=tt?tt.querySelector('i'):null;let langPieChart=null;function capLang(k){if(!k)return"";if(k==='csharp')return'C#';if(k==='cplusplus')return'C++';return k[0].toUpperCase()+k.slice(1)}const savedTheme=localStorage.getItem('theme');function applyTheme(t){if(!b)return;b.classList.toggle('dark-mode',t==='dark');if(ti){ti.classList.toggle('fa-sun',t==='dark');ti.classList.toggle('fa-moon',t!=='dark')}if(langPieChart)updateChartTheme(langPieChart,t)}if(b)applyTheme(savedTheme||'light');else document.addEventListener('DOMContentLoaded',()=>applyTheme(savedTheme||'light'),{once:!0});if(tt)tt.addEventListener('click',()=>{const nT=b.classList.contains('dark-mode')?'light':'dark';applyTheme(nT);localStorage.setItem('theme',nT)});function createOrUpdatePieChart(cD){const x=document.getElementById('languagePieChart');if(!x)return;const cT=b.classList.contains('dark-mode')?'dark':'light',cColors=getChartColors(cT,cD.labels.length);if(langPieChart)langPieChart.destroy();langPieChart=new Chart(x,{type:'doughnut',data:{labels:cD.labels,datasets:[{label:'Голоса',data:cD.data,backgroundColor:cColors.bg,borderColor:cColors.bc,borderWidth:1,hoverOffset:8}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:'top',labels:{color:cColors.tc,font:{family:"'Poppins',sans-serif",size:12}}},tooltip:{enabled:!0,callbacks:{label:ctx=>{let l=ctx.label||'';if(l)l+=': ';if(ctx.parsed!==null)l+=ctx.raw;return l}},bodyFont:{family:"'Poppins',sans-serif"},titleFont:{family:"'Poppins',sans-serif"}}},animation:{animateScale:!0,animateRotate:!0}}})}function getChartColors(t,nC){const iD=t==='dark',baseCols=['rgba(255,99,132,.8)','rgba(54,162,235,.8)','rgba(255,206,86,.8)','rgba(75,192,192,.8)','rgba(153,102,255,.8)','rgba(255,159,64,.8)','rgba(199,199,192,.8)','rgba(83,102,255,.8)','rgba(100,255,100,.8)','rgba(255,100,100,.8)','rgba(200,150,255,.8)','rgba(150,200,255,.8)'],bgArr=[];for(let i=0;i<nC;i++)bgArr.push(baseCols[i%baseCols.length]);return{bg:bgArr,bc:iD?'rgba(22,33,62,1)':'#fff',tc:iD?'#e0e0e0':'#333'}}function updateChartTheme(cI,t){if(!cI)return;const nDP=cI.data.labels?cI.data.labels.length:(cI.data.datasets[0]?cI.data.datasets[0].data.length:0),cColors=getChartColors(t,nDP);cI.options.plugins.legend.labels.color=cColors.tc;cI.data.datasets.forEach(ds=>{ds.backgroundColor=cColors.bg;ds.borderColor=cColors.bc});cI.update()}document.addEventListener('DOMContentLoaded',async()=>{if(!b)return;b.style.opacity=0;requestAnimationFrame(()=>{b.style.transition='opacity .5s ease-in';b.style.opacity=1});applyTheme(localStorage.getItem('theme')||'light');const cEl=document.getElementById('languagePieChart'),cH=cEl?cEl.parentElement:null;if(!cEl||!cH){const mC=document.querySelector('.container');if(mC&&!cEl){const p=document.createElement('p');p.textContent='Не удалось загрузить диаграмму: элемент canvas не найден.';p.style.textAlign='center';mC.appendChild(p)}return}cH.innerHTML="<p class='loading-chart-data' style='text-align:center;padding:20px'>Загрузка данных для диаграммы...</p>";const allL=['python','javascript','java','csharp','rust','go','cplusplus','swift','kotlin','php','ruby','assembler'];let tVF=0;const fP=allL.map(async lK=>{try{const r=await fetch('http://localhost:8080/api/get-count',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:lK})});if(!r.ok)return{lK,c:0,e:!0};const res=await r.json(),cnt=parseInt(res.count_vote,10);return{lK,c:isNaN(cnt)?0:cnt,e:isNaN(cnt)}}catch(err){return{lK,c:0,e:!0}}});const results=await Promise.allSettled(fP),cL=[],cDP=[];allL.forEach(lK=>{const rFL=results.find(r=>r.status==='fulfilled'&&r.value&&r.value.lK===lK);let cnt=0;if(rFL&&rFL.value&&!rFL.value.e){cnt=rFL.value.c}cL.push(capLang(lK));cDP.push(cnt);if(cnt>0)tVF+=cnt});const lM=cH.querySelector('.loading-chart-data');if(lM)lM.remove();if(!document.getElementById('languagePieChart')&&cH){const nC=document.createElement('canvas');nC.id='languagePieChart';cH.appendChild(nC)}if(tVF>0||cL.length>0)createOrUpdatePieChart({labels:cL,data:cDP});else cH.innerHTML="<p style='text-align:center;padding:20px'>Не удалось загрузить данные для диаграммы или голосов нет.</p>";if(typeof MutationObserver!=='undefined'){const obs=new MutationObserver(m=>{m.forEach(mu=>{if(mu.attributeName==='class'&&mu.target===b)applyTheme(b.classList.contains('dark-mode')?'dark':'light')})});obs.observe(b,{attributes:!0})}});